\documentclass[10pt,a4paper]{article}

\usepackage[a-1b]{pdfx} %high quality pdf
\usepackage{datetime}
\usepackage{numprint}
\usepackage{palatino}
\usepackage{authblk}
\usepackage[margin=0.75in]{geometry}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{titlesec}
\usepackage{listings}

\pdfgentounicode=1

\setlength{\parindent}{2em}
%\setlength{\parskip}{1em}
\renewcommand{\baselinestretch}{1.1}

\begin{document}

\titleformat*{\section}{\LARGE\bfseries}
\titleformat*{\subsection}{\large\bfseries}
\titleformat*{\subsubsection}{\small\bfseries}

\nplpadding{2}
\newdateformat{isodate}{\THEYEAR-\numprint{\THEMONTH}-\numprint{\THEDAY}}

\title{Penetration Testing Report for Ex090\\ \large{\textit{Codename: `PowerUp`}}}
\author{Naman Arora\\\small{Pr0b3 LLC}}
\date{\isodate\today}

\maketitle
\section{Technical Report}
During the assessment of the \textit{F4rmc0rp} internal network, the following vulnerability was discovered,
\subsection{Weak Service Permissions}
	\subsubsection{Risk Rating: 10.0}
	Improper service permission may lead a local user either elevating privileges or adding users with higher privileges (\textit{`BITS`} service in this case).
	\subsubsection{Vulnerability Description}
	When regular users have start/stop permissions on services that run with LocalAdministrator privileges, the said user may run any arbitrary commands by changing the \textit{SERVICE\_BIN\_PATH}.
	This may lead to privilege escalation on the part of the user.
	\subsubsection{Confirmation Method}
	Microsoft provides a utility, \textit{AccessChk} (Link: \href{https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk}{AccessChk}) specifically for this purpose.
	\begin{lstlisting}[language=bash]
		>> accesschk users -cw *
	\end{lstlisting}
	\subsubsection{Remediation}
	Privilege escalation through weak service permissions can be remedied by not giving the normal users permission to start/stop Administrator/Local Administrator controlled services.
	Also, only the Administrator/Local Administrator should have access to directories where the service binaries are stored.

\subsection{Attack Narrative}
A normal user, with either physical or remote access (\textbf{by confirming that its the intended host using \textit{`ipconfig`} and matching the IP address to \textit{`10.30.0.98`}}) to the host may discover vulnerable service by either using the above \textit{accesschk} method or by using a \textit{PowerUp} function \textit{Invoke-AllChecks} (Figure \ref{scan}).
On discovery, the user may exploit it by altering the \textit{SERVICE\_BIN\_PATH} to either elevate current self privileges to Administrator (Figure \ref{elevate}) and/or add a new user with Local Administrative privileges (Figure \ref{srv_abuse}).
\begin{figure}[h!]
	\includegraphics[width=\textwidth]{../pics/checks.png}
	\caption{Checking for Vulnerabilities using PowerUp}
	\label{scan}
\end{figure}
\begin{figure}[h!]
	\includegraphics[width=\textwidth]{../pics/service_abuse.png}
	\caption{Add New User with Admin Privileges \textit{(Here Done through PowerUp)}}
	\label{srv_abuse}
\end{figure}
\begin{figure}[h!]
	\includegraphics[width=\textwidth]{../pics/bits_binpath_update.png}
	\caption{Elevate Current Privileges \textit{(Using `sc config`)}}
	\label{elevate}
\end{figure}
\begin{figure}[h!]
	\includegraphics[width=\textwidth]{../pics/ex090_privileges.png}
	\caption{Elevate Privileges \textit{(Using Mimikatz)}}
	\label{token_elevate}
\end{figure}
\begin{figure}[h!]
	\includegraphics[width=\textwidth]{../pics/hashes.png}
	\caption{\textit{SAM} Hash Dump \textit{(Using Mimikatz)}}
	\label{hashes}
\end{figure}
\begin{figure}[h!]
	\includegraphics[width=\textwidth]{../pics/kerb_golden.png}
	\caption{Generating Golden Kerberos Ticket \textit{(Using Mimikatz)}}
	\label{kerberos}
\end{figure}
\newpage
Once the current user has access to a administrator account, they might use \textit{mimikatz} to do the following,
\begin{itemize}
	\item{Elevate Privileges to \textit{NT Authority\textbackslash System}}\\
		This can be done if the user has access to Admin Command Prompt by using \textit{token::elevate} (Figure \ref{token_elevate}).
	\item{Give Debug Privilege}\\
		This can be done to give the current \textit{mimikatz} process ability to snoop in memory of other processes using \textit{privilege::debug} (Figure \ref{token_elevate})
	\item{Dump \textit{SAM} Database Hashes}\\
		Once the current \textit{mimikatz} has debug privileges, it can dump caches \textit{SAM} database hashes of recently logged in users (Figure \ref{hashes})
	\item{Generate Kerberos Golden Ticket}\\
		This can be done using the \textit{kerberos} module of \textit{mimikatz}.
		User \textit{SID} along with \textit{krbtgt hash} is required. Former can be known via \textit{`whoami \textbackslash user`} utility and latter via \textit{kerberos::hash} form within \textit{mimikatz}.
		The golden ticket can then be generated by using the \textit{kerberos::golden} (Figure \ref{kerberos}).
\end{itemize}

\end{document}
